{{ $fields := get .entity "fields" }}

# Group Assignement
{{ $groups := (index $fields "groups") | default (list) }}
lxd_guests:
  hosts:
    {{ index $fields "hostname" }}:
{{ range $g := $groups }}
{{ $g }}:
  hosts:
    {{ index $fields "hostname" }}:
{{ end }}

# Host Vars
all:
  hosts:
    {{ index $fields "hostname" }}:
      id: {{ get .entity "id" }}
{{- with (index $fields "hostvars") }}
{{ . | toString | nindent 6 }}
{{- end }}
    # Overwrites
{{- with (index $fields "guest_lxc_image") }}
      guest_lxc_image: {{ . }}
{{- end }}

{{- with (index $fields "backup") }}
      backup: {{ . }}
{{- end }}

{{- $reboot := index $fields "os_update_reboot" | default false -}}
{{- if not $reboot }}
      os_update_reboot: deny
{{- end }}

{{- $terraform := index $fields "terraform" | default false -}}
{{- if not $terraform }}
      terraform: false
{{- end }}

{{- with (index $fields "motd_environment") }}
      motd_environment: {{ . }}
      environment: {{ . }}
{{- end }}

{{- with (index $fields "motd_description") }}
      motd_description: {{ . }}
{{- end }}

{{- with (index $fields "motd_tags") }}
      motd_tags:
{{- range $t := . }}
        - {{ $t }}
{{- end }}
{{- end }}

{{- with (index $fields "guest_static_ip") }}
      guest_static_ip: {{ . }}
{{- end }}

